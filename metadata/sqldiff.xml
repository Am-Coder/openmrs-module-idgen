<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<help></help>
	
	<diff>
		<version>1.0</version>
		<author>Partners In Health</author>
		<date>29 November 2009</date>
		<description>
			Initial table creation for managing identifier sources and pooled identifiers
		</description>
		<sql>
			CREATE TABLE `idgen_identifier_source` (
			  `id` int(11) NOT NULL auto_increment,
			  `uuid` char(38) NOT NULL,
			  `name` varchar(255) NOT NULL,
			  `description` varchar(1000),
			  `identifier_type` int(11) NOT NULL default '0',
			  `creator` int(11) NOT NULL default '0',
			  `date_created` datetime NOT NULL default '0000-00-00 00:00:00',
			  `changed_by` int(11) default NULL,
  			  `date_changed` datetime default NULL,
			  `retired` tinyint(1) NOT NULL default 0,
			  `retired_by` int(11) default NULL,
  			  `date_retired` datetime default NULL,
  			  `retire_reason` varchar(255) default NULL,
			  PRIMARY KEY  (`id`),
			  KEY `id for idgen_identifier_source` (`id`),
			  KEY `identifier_type for idgen_identifier_source` (`identifier_type`),
			  KEY `creator for idgen_identifier_source` (`creator`),
			  KEY `changed_by for idgen_identifier_source` (`changed_by`),
			  KEY `retired_by for idgen_identifier_source` (`retired_by`),
			  CONSTRAINT `identifier_type for idgen_identifier_source` FOREIGN KEY (`identifier_type`) REFERENCES `patient_identifier_type` (`patient_identifier_type_id`),
			  CONSTRAINT `creator for idgen_identifier_source` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `changed_by for idgen_identifier_source` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `retired_by for idgen_identifier_source` FOREIGN KEY (`retired_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE `idgen_seq_id_gen` (
			  `id` int(11) NOT NULL,
			  `next_sequence_value` int(11) NOT NULL default -1,
			  `base_character_set` varchar(255) NOT NULL,
			  `first_identifier_base` varchar(50) NOT NULL,
			  `prefix` varchar(20),
			  `suffix` varchar(20),
			  `length` int(11),
			  PRIMARY KEY  (`id`),
			  CONSTRAINT `id for idgen_seq_id_gen` FOREIGN KEY (`id`) REFERENCES `idgen_identifier_source` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE `idgen_remote_source` (
			  `id` int(11) NOT NULL,
			  `url` varchar(255) NOT NULL,
			  PRIMARY KEY  (`id`),
			  CONSTRAINT `id for idgen_remote_source` FOREIGN KEY (`id`) REFERENCES `idgen_identifier_source` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE `idgen_id_pool` (
			  `id` int(11) NOT NULL,
			  `source` int(11),
			  `batch_size` int(11),
			  `min_pool_size` int(11),
			  `sequential` tinyint(1) NOT NULL default 0,
			  PRIMARY KEY  (`id`),
			  KEY `source for idgen_id_pool` (`source`),
			  CONSTRAINT `id for idgen_id_pool` FOREIGN KEY (`id`) REFERENCES `idgen_identifier_source` (`id`),
			  CONSTRAINT `source for idgen_id_pool` FOREIGN KEY (`source`) REFERENCES `idgen_identifier_source` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
						
			CREATE TABLE `idgen_pooled_identifier` (
			  `id` int(11) NOT NULL auto_increment,
			  `uuid` char(38) NOT NULL,
			  `pool_id` int(11) NOT NULL,
			  `identifier` varchar(50) NOT NULL,
			  `date_used` datetime,
			  `comment`  varchar(255),
			  PRIMARY KEY  (`id`),
			  CONSTRAINT `pool_id for idgen_pooled_identifier` FOREIGN KEY (`pool_id`) REFERENCES `idgen_id_pool` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE `idgen_auto_generation_option` (
			  `id` int(11) NOT NULL auto_increment,
			  `identifier_type` int(11) unique NOT NULL,
			  `source` int(11) NOT NULL,
			  `manual_entry_enabled` tinyint(1) NOT NULL default 1,
			  `automatic_generation_enabled` tinyint(1) NOT NULL default 1,
			  PRIMARY KEY  (`id`),
			  CONSTRAINT `identifier_type for idgen_auto_generation_option` FOREIGN KEY (`identifier_type`) REFERENCES `patient_identifier_type` (`patient_identifier_type_id`),
			  CONSTRAINT `source for idgen_auto_generation_option` FOREIGN KEY (`source`) REFERENCES `idgen_identifier_source` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

		</sql>
	</diff>
</sqldiff>